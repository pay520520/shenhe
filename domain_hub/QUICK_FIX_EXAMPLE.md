# 🚀 快速修改示例

## 当前代码 vs 修改后代码

### 📍 位置：`hooks.php` 第36行

#### ❌ 当前代码（最大1440分钟 = 1天）

```php
$intervalMin = max(5, min(1440, $intervalMin));
```

**效果**：
- 用户设置 100 → 实际使用 100 ✅
- 用户设置 1440 → 实际使用 1440 ✅  
- 用户设置 5000 → 实际使用 1440 ⚠️ **被限制了！**

---

#### ✅ 修改方案1：改为7天（推荐）

```php
$intervalMin = max(5, min(10080, $intervalMin));
```

**效果**：
- 用户设置 100 → 实际使用 100 ✅
- 用户设置 1440 → 实际使用 1440 ✅
- 用户设置 5000 → 实际使用 5000 ✅ **生效了！**
- 用户设置 15000 → 实际使用 10080 ⚠️ **超过7天被限制**

---

#### ✅ 修改方案2：改为30天（极限）

```php
$intervalMin = max(5, min(43200, $intervalMin));
```

**效果**：
- 用户设置 5000 → 实际使用 5000 ✅
- 用户设置 20000 → 实际使用 20000 ✅
- 用户设置 50000 → 实际使用 43200 ⚠️ **超过30天被限制**

---

#### ⚠️ 不推荐：改为999999

```php
$intervalMin = max(5, min(999999, $intervalMin));
```

**问题**：
- 999999分钟 = 694天 = 1.9年
- 等于永远不同步
- 没有实际意义

---

## 🔧 完整修改步骤

### Step 1：备份原文件

```bash
cd /path/to/whmcs/modules/addons/domain_hub/
cp hooks.php hooks.php.backup.$(date +%Y%m%d)
```

### Step 2：修改代码

```bash
# 方式1：使用 sed 命令
sed -i 's/min(1440,/min(10080,/g' hooks.php

# 方式2：手动编辑
vi hooks.php
# 找到第36行，将 1440 改为 10080
```

### Step 3：验证修改

```bash
# 检查语法
php -l hooks.php

# 查看修改内容
grep "min(10080" hooks.php
```

### Step 4：测试配置

1. 登录 WHMCS 后台
2. 进入：设置 → 附加组件 → 阿里云DNS 域名分发 → 配置
3. 将"同步间隔（分钟）"设置为：**5000**
4. 保存配置
5. 等待 WHMCS cron 执行（或手动执行 `php cron.php`）
6. 检查任务队列：

```sql
SELECT id, type, created_at, status
FROM mod_cloudflare_jobs
WHERE type = 'calibrate_all'
ORDER BY id DESC LIMIT 5;
```

**预期结果**：
- 修改前：任务间隔是 1440 分钟
- 修改后：任务间隔是 5000 分钟 ✅

---

## 📊 对比表格

| 用户设置 | 当前代码(1440) | 改为10080 | 改为43200 | 改为999999 |
|----------|----------------|-----------|-----------|------------|
| 100分钟 | 100 ✅ | 100 ✅ | 100 ✅ | 100 ✅ |
| 1440分钟(1天) | 1440 ✅ | 1440 ✅ | 1440 ✅ | 1440 ✅ |
| 5000分钟(3.5天) | 1440 ⚠️ | 5000 ✅ | 5000 ✅ | 5000 ✅ |
| 10080分钟(7天) | 1440 ⚠️ | 10080 ✅ | 10080 ✅ | 10080 ✅ |
| 20000分钟(14天) | 1440 ⚠️ | 10080 ⚠️ | 20000 ✅ | 20000 ✅ |
| 43200分钟(30天) | 1440 ⚠️ | 10080 ⚠️ | 43200 ✅ | 43200 ✅ |
| 100000分钟(69天) | 1440 ⚠️ | 10080 ⚠️ | 43200 ⚠️ | 100000 ⚠️ |

**说明**：
- ✅ = 按用户设置生效
- ⚠️ = 被强制限制

---

## 🎯 推荐配置

### 场景1：中小型部署（默认不改）

```
代码：min(1440, $intervalMin)
配置：60-120 分钟
```

### 场景2：大型部署（改为7天）

```
代码：min(10080, $intervalMin)  ← 修改这里
配置：1440-5000 分钟
```

### 场景3：超大型/稳定环境（改为30天）

```
代码：min(43200, $intervalMin)  ← 修改这里
配置：10080-43200 分钟
```

---

## ⚠️ 常见错误

### 错误1：改错位置

```php
// ❌ 错误：改成了下限
$intervalMin = max(10080, min(1440, $intervalMin));
//                 ^^^^^ 不要改这里！

// ✅ 正确：改上限
$intervalMin = max(5, min(10080, $intervalMin));
//                        ^^^^^ 改这里！
```

### 错误2：值太大

```php
// ❌ 不推荐
$intervalMin = max(5, min(999999999, $intervalMin));
//                        ^^^^^^^^^ 太大了！

// ✅ 推荐
$intervalMin = max(5, min(43200, $intervalMin));
//                        ^^^^^ 最多30天
```

### 错误3：完全去掉限制

```php
// ❌ 危险：没有上限保护
$intervalMin = max(5, $intervalMin);

// ✅ 安全：保留合理上限
$intervalMin = max(5, min(43200, $intervalMin));
```

---

## 🔄 回滚命令

如果出问题，立即回滚：

```bash
# 恢复备份
cd /path/to/whmcs/modules/addons/domain_hub/
cp hooks.php.backup.20250115 hooks.php

# 或直接改回
sed -i 's/min(10080,/min(1440,/g' hooks.php

# 验证
grep "min(1440" hooks.php
```

---

## ✅ 最终建议

**最佳实践：改为 10080（7天）**

```php
// hooks.php 第36行
$intervalMin = max(5, min(10080, $intervalMin));

// hooks.php 第71行（建议同步修改）
$scanIntervalMin = max(15, min(10080, $scanIntervalMin));
```

**理由**：
1. ✅ 7天已经足够长
2. ✅ 不会造成任务调度问题
3. ✅ 满足大多数场景需求
4. ✅ MySQL时间计算安全
5. ✅ 易于维护和理解

---

**创建时间**：2025-01-XX  
**适用版本**：v2.x+
